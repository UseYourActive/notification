# --- Application Info ---
quarkus.application.name=notification-service
quarkus.application.version=@project.version@

# --- Server Configuration ---
quarkus.http.port=${APP_INTERNAL_PORT:8080}
quarkus.http.limits.max-body-size=${HTTP_MAX_BODY_SIZE:1M}
quarkus.swagger-ui.always-include=${SWAGGER_UI_ENABLED:true}

# --- Logging ---
quarkus.log.level=${LOG_LEVEL:INFO}
quarkus.log.category."bg.sit_varna.sit.si".level=${APP_LOG_LEVEL:DEBUG}
quarkus.log.console.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] [%X{notificationId}] (%t) %s%e%n

# --- Database (PostgreSQL) ---
quarkus.datasource.db-kind=postgresql
quarkus.datasource.username=${QUARKUS_DATASOURCE_USERNAME}
quarkus.datasource.password=${QUARKUS_DATASOURCE_PASSWORD}
quarkus.datasource.jdbc.url=jdbc:postgresql://${DB_HOST}:${QUARKUS_DATASOURCE_PORT}/${QUARKUS_DATASOURCE_DB}
quarkus.datasource.jdbc.min-size=${DB_MIN_POOL:2}
quarkus.datasource.jdbc.max-size=${DB_MAX_POOL:20}

# --- Hibernate ---
quarkus.hibernate-orm.db-generation=${DB_GENERATION:none}
quarkus.hibernate-orm.log.sql=${HIBERNATE_LOG_SQL:false}
quarkus.hibernate-orm.validate-in-dev-mode=${VALIDATE_IN_DEV_DB:true}
quarkus.hibernate-orm.mapping.format.global=ignore
# could be redundant
quarkus.hibernate-orm.schema-management.strategy=update

# --- Flyway Configuration ---
quarkus.flyway.migrate-at-start=true
quarkus.flyway.baseline-on-migrate=true
# Clean schema in dev/test for fresh starts
%test.quarkus.flyway.clean-at-start=true

# --- Redis Configuration ---
quarkus.redis.hosts=${REDIS_HOST}
quarkus.redis.client-name=notification-service
quarkus.redis.timeout=${REDIS_TIMEOUT:10s}

# Metrics & Cache
redis.metrics.enabled=true
redis.cache.enabled=true
redis.cache.ttl=${CACHE_TTL:1h}
# Rate Limiting
redis.rate-limit.enabled=${REDIS_RATE_LIMIT_ENABLED:true}
redis.rate-limit.email-max=${RATE_LIMIT_EMAIL:10}
redis.rate-limit.email-window=1h
redis.rate-limit.sms-max=${RATE_LIMIT_SMS:5}
redis.rate-limit.sms-window=1h
redis.rate-limit.telegram-max=${RATE_LIMIT_TELEGRAM:20}
redis.rate-limit.telegram-window=1h
# Deduplication
redis.deduplication.enabled=${REDIS_DEDUPLICATION_ENABLED:true}
redis.deduplication.ttl=${REDIS_DEDUPLICATION_TTL:5m}

# --- Email (SendGrid) ---
email.provider=${EMAIL_PROVIDER:sendgrid}
quarkus.mailer.host=${MAILER_HOST}
quarkus.mailer.port=${MAILER_PORT}
quarkus.mailer.username=${MAILER_USERNAME}
quarkus.mailer.password=${SENDGRID_API_KEY}
quarkus.mailer.from=${SENDGRID_FROM_EMAIL}
quarkus.mailer.start-tls=REQUIRED
quarkus.mailer.auth-methods=PLAIN LOGIN
# Webhook
sendgrid.webhook-public-key=${SENDGRID_WEBHOOK_KEY}
# Redundancy?
quarkus.mailer.tls=true
quarkus.mailer.login=REQUIRED
quarkus.mailer.mock=false

# --- SMS (Twilio) ---
sms.provider=${SMS_PROVIDER:twilio}
twilio.account.sid=${TWILIO_ACCOUNT_SID}
twilio.auth.token=${TWILIO_AUTH_TOKEN}
twilio.phone.number=${TWILIO_PHONE_NUMBER}

# --- Telegram ---
telegram.enabled=${TELEGRAM_ENABLED:false}
telegram.bot.token=${TELEGRAM_BOT_TOKEN}
telegram.bot.username=${TELEGRAM_BOT_USERNAME}
telegram.default-parse-mode=HTML

# Resilience
bg.sit_varna.sit.si.service.channel.telegram.TelegramApiSender/sendMessage/Retry/maxRetries=${TELEGRAM_RETRY_MAX:5}
bg.sit_varna.sit.si.service.channel.telegram.TelegramApiSender/sendMessage/Timeout/value=${TELEGRAM_TIMEOUT_SEC:15}

# --- Core Resilience ---
bg.sit_varna.sit.si.service.async.NotificationProcessor/processNotification/Retry/maxRetries=${RETRY_MAX_ATTEMPTS:3}
bg.sit_varna.sit.si.service.async.NotificationProcessor/processNotification/Retry/delay=${RETRY_DELAY:2000}

# --- Native Build Settings ---
# SendGrid / Apache HttpClient static randomizer issue
# Used for the GraalVM to wait for the application to actually start in native mode
quarkus.native.additional-build-args=--initialize-at-run-time=org.apache.http.impl.auth.NTLMEngineImpl

# --- Kubernetes / Docker Build ---
quarkus.container-image.build=true
quarkus.container-image.group=quarkus
quarkus.container-image.name=notification-service
# Tells Quarkus to use the local Docker daemon (so K8s can see the image)
quarkus.kubernetes.image-pull-policy=IfNotPresent
quarkus.kubernetes.service-type=NodePort
quarkus.kubernetes.env-from[0].secret=notification-env-secret
quarkus.kubernetes.env.secrets=notification-env-secret

# Qute
quarkus.qute.content-types.html=text/html
quarkus.qute.content-types.txt=text/plain

# Localization
quarkus.default-locale=en
quarkus.locales=en,bg

%test.quarkus.mailer.host=localhost
%test.quarkus.mailer.port=2525
%test.quarkus.mailer.mock=true

%test.sendgrid.api-key=mock-sendgrid-key
%test.sendgrid.from-email=test@example.com

%test.telegram.bot.token=mock-telegram-token
%test.telegram.bot.username=mock-bot-username

%test.twilio.account.sid=mock-twilio-sid
%test.twilio.auth.token=mock-twilio-token
%test.twilio.phone.number=+15550000000